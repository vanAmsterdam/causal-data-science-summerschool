{
  "hash": "7ab739af252d749f1f1b060a2d4f19ed",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Causal perspectives on prediction modeling\"\nauthor: \"Wouter van Amsterdam\"\ndate: \"2024-08-08\"\nformat: \n    revealjs:\n        #theme: [default, umcu.scss]\n        incremental: true\n        width: 1920\n        height: 1080\n        logo: ../umcu_blue.png\n        center: true\n        include-before: [ '<script type=\"text/x-mathjax-config\">MathJax.Hub.Config({tex2jax: {enableAssistiveMml: false}});</script>']\nexecute:\n    warning: false\n    message: false\nbibliography: library.bib\n---\n\n## Recap: causal questions\n\n- questions of *association* are of the kind:\n  - what is the probability of $Y$ (potentially: after observing $X$)?, e.g.:\n    - what is the chance of rain tomorrow given that is was dry today?\n    - what is the chance a patient with lung cancer lives more than 10% after diagnosis?\n  - these *hands behind your back and passively observe the world*-questions\n- *causal* questions are of the kind:\n  - how would $Y$ change when we intervene on $T$?, e.g.:\n    - if we would send all pregant women to the hospital for delivery, what would happen with neonatal outcomes?\n    - if we start a marketing campain, by how much would our revenue increase?\n  - these tell us what would happen if we changed something\n\n# What is prediction?\n\n## Examples of prediction tasks\n\nobserve an $X$, want to know what to expect for $Y$\n\n[1. X = patient caughs, Y = patient has lung cancer]{.fragment fragment-index=1}\n\n[2. X = ECG, Y = patient has heart attack]{.fragment fragment-index=2}\n\n[3. X = CT-scan, Y = patient dies within 2 years]{.fragment fragment-index=3}\n\n::::{.r-stack}\n\n:::{.fragment .fade-in-then-out fragment-index=2}\n![Renziehausen (2024). ECG normalized-2.jpgCoronary spasm - a cause of acute coronary syndrome with ST-segment elevation and refractory cardiogenic shock - a case report. figshare. Figure. https://doi.org/10.6084/m9.figshare.26045203.v1](figs/ecg.jpg){height=400}\n:::\n\n:::{.fragment .fade-in-then-out fragment-index=3}\n![M Sherigar, Jagannath; Finnegan, Joseen; McManus, Damien; F Lioe, Tong; AJ Spence, Roy (2011). CT Scan of chest showing one of the lung nodules. figshare. Figure. https://doi.org/10.6084/m9.figshare.16069.v1](figs/ctlung.jpg){height=400}\n:::\n\n::::\n\n## Prediction: typical approach\n\n1. define population, find a cohort\n2. measure $X$ at *prediction baseline*\n3. measure $Y$\n   a. cross-sectional (e.g. diagnosis)\n   b. longitudinal follow-up (e.g. survival)\n4. use a statistical learning technique (e.g. regression, machine learning), fit model $f$ to observed $\\{x_i,y_i\\}$ with a criterion / loss function\n5. evaluate prediction performance with e.g. discrimination, calibration, $R^2$\n\n## Curve fitting\n\n\n::: {.cell}\n\n:::\n\n\n## Prediction: typical estimand\n\nLet $f$ depend on parameter $\\theta$, prediction typically aims for:\n\n$$f_{\\theta}(x) \\to E[Y|X=x]$$\n\n- when $Y$ is binary:\n  - probability of a heart attack in 10 years, given age and cholesterol\n  - probability of lung cancer, given symptoms and CT-scan\n  - typical evaluation metrics:\n    - discrimination: sensitivity, specificity, AUC\n    - calibration\n\n## Causal inference: typical approach\n\n1. define target population and targeted treatment comparison\n2. run randomized controlled trial, randomizing treatment allocation (when possible)\n3. measure patient outcomes\n4. estimate parameter that summarizes *average treatment effect* (ATE)\n\n:::{.fragment}\n\ntypical estimand:\n\n$$E[Y|\\text{do}(T=1)] - E[Y|\\text{do}(T=0)]$$\n\n:::\n\n## Causal inference versus prediction\n\n:::{.columns}\n\n::::{.column width=\"50%\"}\n\nprediction\n\n- typical estimand $E[Y|X]$\n- typical study: longitudinal cohort\n- typical interpretation: $X$ predicts $Y$\n- primary use: know what $Y$ to expect when observing a new $X$ *assuming no change in joint distribution*\n\n::::\n\n::::{.column width=\"50%\"}\n\ncausal inference\n\n- typical estimand $E[Y|\\text{do}(T=1)] - E[Y|\\text{do}(T=0)]$\n- typical study: RCT (or observational causal inference study)\n- typical interpretation: *causal effect* of $T$ on $Y$\n- primary use: know what change in $Y$ to expect when *changing the treatment policy*\n\n::::\n\n:::\n\n## What do we mean with treatment policy?\n\nA treatment policy $\\pi$ is a procedure for determining the treatment\n\nAssuming $T$ is binary, $\\pi$ can be:\n\n- $\\pi = 0.5$ (a 1/1 RCT)\n- give blood pressure pill to patients with hypertension:\n\n[$$\\pi(blood pressure) = \\begin{cases}\n  1, &blood pressure > 140mmHg\\\\\n  0, &\\text{otherwise}\n  \\end{cases}$$]{.fragment}\n\n- give statins to patients with more than 10% predicted risk of heart attack:\n\n[$$\\pi(X) = \\begin{cases}\n  1, &f(X) > 0.1\\\\\n  0, &\\text{otherwise}\n  \\end{cases}$$]{.fragment}\n\n- the propensity score can be seen as a (non-deterministic) treatment policy\n\n\n## Where can prediction and causality meet?\n\n1. prediction has a causal interpretation\n2. prediction does not have a causal interpretation:\n   a. but is used for a causal task (e.g. treatment decision making)\n   b. but predictions can be improved with causal thinking in terms of e.g.:\n     - interpretability, robustness, 'spurious correlations', generalization, fairness, selection bias\n\n# 2a. Prediction model used for a causal task\n\n--- \n\n![](figs/8q8oy7_meme_crossover.jpg){fig-align=\"center\"}\n\n## Using prediction models for decision making is often thought of as a good idea\n\nFor example:\n\n1. give chemotherapy to cancer patients with high predicted risk of recurrence\n2. give statins to patients with a high risk of a heart attack\n\n. . . \n\n::: {.callout-note icon=false}\n## TRIPOD+AI on prediction models [@collinsTRIPODAIStatement2024]\n\n“Their primary use is to support clinical decision making, such as ... **initiate treatment or lifestyle changes.**” \n\n:::\n\n---\n\n:::{.callout-warning}\n\n## This may lead to bad situations when:\n\n1. ignoring the treatments patients may have had during training / validation of prediction model\n2. only considering measures of predictive accuracy as sufficient evidence for safe deployment\n\n\n:::\n\n# When accurate prediction models yield harmful self-fulfilling prophecies{#selffulfilling}\n\n---\n\n:::{.r-stack}\n\n![](figs/rt_example1.png){.fragment height=24cm}\n\n![](figs/rt_example2.png){.fragment height=24cm}\n\n![](figs/rt_example3.png){.fragment height=24cm}\n\n![](figs/rt_example4.png){.fragment height=24cm}\n\n![](figs/rt_example5.png){.fragment height=24cm}\n\n![](figs/rt_example6.png){.fragment height=24cm}\n\n![](figs/rt_example.png){.fragment height=24cm}\n\n:::\n\n\n## Building models for decision support without regards for the historic treatment policy is a bad idea\n\n:::{.r-stack}\n\n![](figs/policy_changea1.png){.fragment width=\"100%\"}\n\n![](figs/policy_changea3.png){.fragment width=\"100%\"}\n\n![](figs/policy_changeax.png){.fragment width=\"100%\"}\n\n![](figs/policy_changeb2.png){.fragment width=\"100%\"}\n\n![](figs/policy_changebx.png){.fragment width=\"100%\"}\n\n:::\n\n--- \n\n[The question is not \"is my model accurate before / after deployment\",]{.r-fit-text}\n\n[but did deploying the model improve patient outcomes?]{.r-fit-text .fragment}\n\n\n## Treatment-naive prediction models\n\n:::{.r-stack}\n\n![](figs/txnaive1.png)\n\n![](figs/txnaive2b.png){.fragment}\n\n:::\n\n\\begin{align}\n    E[Y|X] \\class{fragment}{= E[E_{t~\\sim \\pi_0(X)}[Y|X,t]]}\n\\end{align}\n\n---\n\n[Is this obvious?]{.r-fit-text}\n\n<!--::: {.callout-tip}-->\n\n<!--It may seem obvious that you should not ignore historical treatments in your prediction models, if you want to improve treatment decisions, but many of these models are published daily, and some guidelines even allow for implementing these models based on predictve performance only-->\n\n<!--:::-->\n\n## Prediction modeling is very popular in medical research\n\n![](figs/predmodelsoverview.png){fig-align='center'}\n\n## Recommended validation practices and reporting guidelines do not protect against harm\n\n### because they do not evaluate the policy change\n\n:::{.columns}\n\n::::{.column width=\"50%\"}\n\n![](figs/ajcc_title.png){fig-align=\"center\"}\n\n::::\n\n::::{.column width=\"50%\"}\n\n![](figs/tripod_ai.png){fig-align=\"center\"}\n\n::::\n\n:::\n\n\n\n## Bigger data does not protect against harmful prediction models\n\n![](figs/biggerdata.png){fig-align=\"center\"}\n\n## More flexible models do not protect against harmful prediction models\n\n![](figs/morelayers.png){fig-align=\"center\"}\n\n<!-- TODO make mindthegap background image -->\n\n---\n\n::: {.r-stretch}\n\n![](figs/mindthegap.png){fig-align=\"center\"}\n\n:::\n\n## {auto-animate=true}\n\n::: {style=\"margin-top: 200px; font-size: 3em; color: red;\"}\nWhat to do?\n:::\n\n## {auto-animate=true}\n\n::: {style=\"margin-top: 100px\"}\nWhat to do?\n:::\n\n1.  Evaluate policy change (cluster randomized controlled trial)\n2.  Build models that are likely to have value for decision making\n\n# How to evaluate the effect of a new treatment policy?{#sec-modeleval}\n\n## Deploying a model is an intervention that changes the way treatment decisions are made\n\n![](figs/policy_changebx.png){fig-align=\"center\"}\n\n## How do we learn about the effect of an intervention?\n\nWith causal inference!\n\n- for using a decision support model, the unit of intervention is usually *the doctor*\n- randomly assign *doctors* to have access to the model or not\n- measure differences in **treatment decisions** and **patient outcomes**\n- this called a cluster RCT\n- if using model improves outcomes, use that one\n\n. . . \n\n:::{.callout-tip icon=\"false\"}\n\n## Using cluster RCTs to evaluated models for decision making is not a new idea [@cooperEvaluationMachinelearningMethods1997]\n\n“As one possibility, suppose that a trial is performed in which clinicians are randomized either to have or not to have access to such a decision aid in making decisions about where to treat patients who present with pneumonia.” \n\n:::\n\n. . .\n\n:::{.callout-warning}\n## What we don't learn\nwas the model predicting anything sensible?\n:::\n\n## Calculating the effect of a policy from existing data\n\n- we have data where $t \\sim \\pi_0(X)$\n- we want to know the expected value of $Y$ when instead $t \\sim \\pi_1(X)$\n- how to compute this? with importance sampling!\n- importance sampling:\n  - want to compute the expected value of function $g(x)$ over a distribution $\\color{green}{p}$: $E_{x \\sim \\color{green}{p}}[g(x)]$\n  - instead, we are given samples from a different distribution $x \\sim \\color{red}{q}$\n  - if we know $\\color{green}{p}(x)$ and $\\color{red}{q}(x)$, we can do:\n\n    $$E_{x \\sim \\color{red}{q}(x)} \\left[ \\frac{\\color{green}{p}(x)}{\\color{red}{q}(x)} g(x) \\right]$$\n  - where $\\frac{\\color{green}{p}(x)}{\\color{red}{q}(x)}$ are the *importance weights* (for a proof see @sec-is)\n \n## Special cases for importance sampling and policy evaluation\n\n1. propensity score reweighting:\n   - target distribution $p(t|x)=p(t)$ (as in RCT)\n   - observed distribution $q(t|x) = \\pi_0(x)$ (the propensity score)\n   - this is why propensity score reweighting mimics an RCT\n\n## Special cases for importance sampling and policy evaluation{#sec-policyeval}\n\n2. have historic RCT data, want to evaluate new policy $\\pi_1$\n   - target distribution $p(t|x)=\\pi_1(x)$\n   - observed distribution $q(t|x) = 0.5$\n   - note: when $\\pi_1(x)$ is deterministic (e.g. give the treatment when $f(x) > 0.1$), we get the following:\n     a. when randomized treatment is concordant with $\\pi_1$, keep the patient (weight = 1), otherwise, remove from the data (weight = 0)\n     b. calculate average outcomes in the kept patients\n   - this way, multiple alternative policies may be evaluated\n3. have historic observational data, want to evaluate new policy $\\pi_1$:\n   - target distribution $p(t|x)=\\pi_1(x)$\n   - observed distribution $q(t|x) = \\pi_0(x)$\n   - we need to estimate $q$ (i.e. the propensity score), this procedure relies on the standard causal inference assumptions (no confounding, positivity)\n\n---\n\nHow to build prediction models for decision support?\n\n# 1. Prediction has a causal interpretation\n\n## What can we mean with predictions having a causal interpretation?\n\nLet $f: \\mathbb{X} \\to \\mathbb{Y}$ be a prediction model for outcome $Y$ using features $X$\n\n::::{layout-ncol=2}\n\n:::::{.column}\n\n1. $X$ is an ancestor of $Y$ ($X=\\{z_1,z_2,z_3\\}$)\n2. $X$ is a direct cause of $Y$ ($X=\\{z_1,z_2\\}$)\n3. $f: \\mathbb{X} \\to \\mathbb{Y}$ describes the causal effect of $X$ on $Y$ ($X=\\{z_1\\}$), i.e.: \n\n:::{.fragment}\n\n$$f(x) = E[Y|\\text{do}(X=x)]$$\n\n:::\n\n4. $f: \\mathbb{T} \\times \\mathbb{X} \\to \\mathbb{Y}$ describes the causal effect of $T$ on $Y$ conditional on $X$ ($T=\\{z_1\\},X=\\{z_2,z_3,w\\}$:\n   \n:::{.fragment}\n\n$$f(t,x) = E[Y|\\text{do}(T=t),X=x]$$\n\n:::\n\n:::::\n \n![](tikzs/dag-preds.png)\n\n::::\n\n## interpretation 3. all covariates are *causal*\n\nLet $f: \\mathbb{X} \\to \\mathbb{Y}$ be a prediction model for outcome $Y$ using features $X$\n\n\n$$f(x) = E[Y|\\text{do}(X=x)]$$\n\n- this is almost never true (i.e. back-door rule holds for **all** variables)\n- too often this is assumed / interpreted this way (*table 2 fallacy* in health care literature)\n\n## Example of table 2 fallacy when mis-using Qrisk\n\n[Qrisk3](https://www.qrisk.org): a risk prediction model for cardiovascular events in the coming 10-years.\nWidely used in the United Kingdom for deciding which patients should get statins\n\n![](figs/qrisk3-screenshot.png)\n\n## Qrisk3 - risks:\n\ncan go wrong when:\n\n- e.g. fill in current length and weight\n    - reduce weight by 5 kgs\n    - interpret difference as 'effect of weight loss'\n- check or un-check blood pressure medication\n  - observe that with blood pressure medication, risk is higher\n\n## What else could go wrong?\n\n- Qrisk3 states it is validated, but validated for what?\n- Qrisk3 is validated for non-use!\n\n## interpretation 4. some covariates are *causal* \n\n### or: prediction-under-intervention\n\n$$f(t,x) = E[Y|\\text{do}(T=t),X=x]$$\n\n![](tikzs/policy.png){height=500}\n\n- interpretation: *what is the expected value of $Y$ if we were to assign treatment $t$ by intervention, given that we know $X=x$ in this patient*\n\n--- \n\n:::{.columns}\n\n::::{.column width=\"50%\"}\n\nusing *treatment naive* prediction models for decision support\n\n![](figs/8q8oy7_meme_crossover.jpg){fig-align=\"center\"}\n\n::::\n\n::::{.column width=\"50%\"}\n\nprediction-under-intervention\n\n![](figs/peanutbutter_chocolatesprinkles.jpg){.fragment fig-align=\"center\"}\n\n::::\n:::\n\n## Estimand for prediction-under-intervention models\n\nWhat is the estimand?\n\n- prediction: $E[Y|X]$\n- average treatment effect: $E[Y|\\text{do}(T=1)] - E[Y|\\text{do}(T=0)]$\n- conditional average treatment effect: $E[Y|\\text{do}(T=1),X] - E[Y|\\text{do}(T=0),X]$\n- prediction-under-intervention: $E[Y|\\text{do}(T=t),X]$\n\n[note:]{.fragment}\n\n- from prediction-under-intervention models, the CATE can be derived\n- in these models and the CATE: $T$ has a causal interpretation, $X$ does not!\n  - i.e. $X$ does not *cause* the effect of treatment to be different\n\n\n## Developing prediction-under-intervention models\n\n- requires causal inference assumptions or RCTs\n- single RCTs often not big enough, or did not measure the right $X$s\n- when $X$ is not a sufficient adjustment set, but $X+L$ is, can use e.g. propensity score methods\n- assumption of no unobserved confounding often hard to justify in observational data\n- but there's more between heaven (RCT) and earth (confounder adjustment)\n\n  :::{.nonincremental}\n  - proxy-variable methods [e.g. @miaoIdentifyingCausalEffects2018;@vanamsterdamIndividualTreatmentEffect2022]\n  - constant relative treatment effect assumption [e.g. @alaaMachineLearningGuide2021; @vanamsterdamConditionalAverageTreatment2023; @candidodosreisUpdatedPREDICTBreast2017]\n  - diff-in-diff\n  - instrumental variable analysis [@waldFittingStraightLines1940; @puliGeneralControlFunctions2021;@hartfordDeepIVFlexible2017]\n  - front-door analysis\n\n  :::\n\n- not covered now: formulating correct estimands (and getting the right data) becomes much more complicated when considering dynamic treatment decision processes (e.g. blood pressure control with multiple follow-up visits)\n\n## Evaluation of prediction-under-intervention models\n\n- prediction accuracy can be tested in RCTs, or in observational data with specialized methods accounting for confounding [e.g. @keoghPredictionInterventionsEvaluation2024]\n- in confounded observational data, typical metrics (e.g. AUC or calibration) are not sufficient as we want to predict well in data from *other distribution than observed data* (i.e. other treatment decisions)\n- a new *policy* can be evaluated in historic RCTs [e.g. @karmaliBloodPressureloweringTreatment2018]\n- ultimate test is cluster RCT\n- if not perfect, likely a better recipe than *treatment-naive* models\n\n# 2b. improving non-causal prediction models with causality\n\n- interpretability\n- robustness / 'spurious correlations' / generalization\n- fairness\n- selection bias\n\n## Interpretability\n\n- end-users (e.g. doctors) often want to understand *why* a prediction model returns a certain prediction\n- this has two possible interpretations:\n  a. explain the model (i.e. the computations)\n  b. explain the world (i.e. why is this patient at high risk of a certain outcome)\n- b. often has a causal connotation, though achieving this is may be unfeasible as you need causal assumptions on all covariates (rember table 2 fallacy)\n\n## Robustness / spurious correlations / generalization\n\n- prediction models are developed in some data, but are intended to be used elsewhere (in location, time, other)\n- in causal language, shifts in distributions can be denoted as interventions on specific nodes\n- prediction models that include (direct) causes may be more robust to changes as the chain between $X$ and $Y$ is shorter\n- some machine learning algorithms like deep learning are very good at detecting 'background' signals, e.g.:\n  - detect the scanner type from a CT-scanner\n    - if hospital A has scanner type 1 and hospital B has scanner type 2\n    - and the outcome rates differ between the hospitals, models may (mis)use the scanner type to predict the outcome\n    - what will the model predict in hospital C? or when A or B buy a scanner of different type?\n  - may be preventable with causality\n\n## Fairness\n\n- in the historic distribution, outcomes may be affected by unequal treatment of certain demographic groups\n- instead of perpetuating inequities, we may want to design models that diminish them\n- this means intervening in the distribution (= a causal task)\n- causality has a strong vocabulary for formalizing fairness\n- actually achieving fairness is highly non-trivial, not in the least part due to unclear definitions\n- chosing to not include sensitive attributes in a prediction model is often not gauranteed to improve fairness\n\n## Selection bias\n\n- have samples from some selected subpopulation\n  - university hospital\n  - older men\n- want to generalize to another subpopulation\n  - general practitioner\n  - younger women\n- use DAGs to express the difference between source and target population\n- calculate e.g. expected performance on target population with techniques like importance sampling\n\n## Wrap-up\n\n- predictions can have causal interpretations\n- prediction-under-intervention: causal with respect to treatment (not covariates)\n- mis-use of non-causal models for causal tasks (e.g. prediction model for treatment decisions) is perilous\n  - always think about the policy change and its effect on outcomes\n- evaluate policy changes with cluster RCTs, or historic RCTs and importance sampling\n- causal thinking may improve other aspects of non-causal prediction models such as robustness, fairness, generalization\n\n## Proof of importance sampling unbiasedness{#sec-is .nonincremental}\n\nassuming $x$ is discrete, otherwise replace sums with integrals for continuous $x$\n\nwant to compute the expected value of $g(x)$ over distribution $p$, but we have samples from another distribution $x \\sim q$\n\n\n$$E_{x \\sim q} \\left[ \\frac{p(x)}{q(x)} g(x) \\right] = \\sum_x q(x) \\left( \\frac{p(x)}{q(x)} g(x) \\right) = \\sum_x p(x) g(x) = E_{x \\sim p} \\left[g(x) \\right]$$\n\nthis assumes $q(x)>0$ whenever $p(x)>0$ for the ratio $p/q$ to be defined\n\n## References\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}