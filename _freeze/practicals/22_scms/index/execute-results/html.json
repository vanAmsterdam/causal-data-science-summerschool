{
  "hash": "e5e5dbbc27c5b2019512ecbe43b7396e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Practical: Structural Causal Models and Meta-learners\"\nsubtitle: \"Identification and Hierarchy of Questions\"\nauthor: \"Wouter van Amsterdam\"\neval: false\nformat: \n  html:\n    toc: true\n    self-contained: true\n    code-fold: true\n    df-print: paged\n    callout-appearance: simple\n    callout-icon: false\n---\n\n\n\n<!--## practical 2-->\n\n  <!--- causal ladder: what Q is this?-->\n  <!--- give data of hierarchy and answer the Q-->\n  <!--- give data of 2 treatments + SCM (treatment 3 which can be extrapolated from)-->\n\n\nIn this practical you'll learn more about identification and counterfactuals using the Structural Causal Model approach, and meta-learners\n\n# Identification\n\n:::{.callout-note collapse=\"false\"}\n\n## Remember the definition of identification in [the lecture on SCMs](../../lectures/day2-scms/lec3-scms.qmd#sec-identification):\n\n\nLet $Q(M)$ be any computable quantity of a model $M$.\nWe say that $Q$ is **identifiable** in a class $\\mathbb{M}$ of models if, for any pairs of models $M_1$ and $M_2$ from $\\mathbb{M}$,\n$Q(M_1) = Q(M_2)$ whenever $P_{M_1} (y) = P_{M_2} (y)$.\nIf our observations are limited and permit only a partial set $F_M$ of features (of $P_M(y)$) to be estimated,\nwe define $Q$ to be identifiable from $F_M$ if $Q(M_1) = Q(M_2)$ whenever $F_{M_1} = F_{M_2}$.\n\n:::\n\nWe have two different datasets, for which we know they came from the following DAG:\n\n![DAG U](_tikzs/dagu.png){#fig-dagu}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrequired_pkgs <- c(\"marginaleffects\", \"ggplot2\", \"data.table\")\ncran_repo <- \"https://mirror.lyrahosting.com/CRAN/\" # <- a CRAN mirror in the Netherlands, can select another one from here https://cran.r-project.org/mirrors.html\n\nfor (pkg in required_pkgs) {\n  if (!requireNamespace(pkg, quietly = TRUE)) {\n    install.packages(pkg, repos=cran_repo)\n  }\n}\n\nsuppressPackageStartupMessages({\n  # Load packages\n  library(marginaleffects)\n  library(ggplot2)\n  library(data.table)\n})\n\nsource(here::here(\"practicals\", \"22_scms\", \"_makedatas.R\"))\ndatas <- make_datas()\n\ndata1 <- datas[[\"data1\"]]\ndata2 <- datas[[\"data2\"]]\n```\n:::\n\n\n\n::: {.callout-tip collapse=\"true\"}\n\n## The datasets can alternatively be downloaded here:\n\n|data|link|\n|----|----|\n|`data1`|[data1.csv](datas/data1.csv)\n|`data2`|[data2.csv](datas/data2.csv)\n\n\n:::\n\n::: {.callout-note collapse=\"true\"}\n\n## state the ATE in terms of expected values of 'do' expressions\n\nanswer: $$\\text{ATE} = E[Y|\\text{do}(X=1)] - E[Y|\\text{do}(X=0)]$${#eq-ate}\n\n:::\n\n::: {.callout-note collapse=\"true\"}\n\n## we did not measure $U$, can we estimate this target query based on the DAG, using the observed data \n\nanswer: no, there is an open back-door path through $U$ which we cannot block as we did not observe that variable\n\n:::\n\n`data1` and `data2` come from the same DAG but from different SCMs\n\n::: {.callout-note collapse=\"true\"}\n\n## How can this be? What does this mean?\n\nanswer: the endogenous variables have the same parents, so the DAG is the same. The structural equations are different\n\n:::\n\nWe can estimate four features of the observed distribution: $P(Y=1|X=0),P(Y=1|X=1),P(Y=1),P(X=1)$.\nObserve that for `data1` and `data2`, these are approximately the same (up to sampling variation)\n\n::: {.callout-tip collapse=\"true\"}\n\n## Estimate them from the observed data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmean(data1[data1$x==0,\"y\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.3381743\n```\n\n\n:::\n\n```{.r .cell-code}\nmean(data1[data1$x==1,\"y\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.6949807\n```\n\n\n:::\n\n```{.r .cell-code}\nmean(data1[,\"y\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.523\n```\n\n\n:::\n\n```{.r .cell-code}\nmean(data1[,\"x\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.518\n```\n\n\n:::\n\n```{.r .cell-code}\nmean(data2[data2$x==0,\"y\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.2944664\n```\n\n\n:::\n\n```{.r .cell-code}\nmean(data2[data2$x==1,\"y\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.6862348\n```\n\n\n:::\n\n```{.r .cell-code}\nmean(data2[,\"y\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.488\n```\n\n\n:::\n\n```{.r .cell-code}\nmean(data2[,\"x\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.494\n```\n\n\n:::\n:::\n\n\n\n:::\n\n::: {.callout-note collapse=\"true\"}\n\n## Use the fact that `u` is in the data to calculate the actual effect in both datasets, what are the answers?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit1 <- glm(y~x*u, data=data1, family=binomial)\nfit2 <- glm(y~x*u, data=data2, family=binomial)\navg_comparisons(fit1, variables=\"x\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Term          Contrast Estimate Std. Error      z Pr(>|z|)   S  2.5 % 97.5 %\n    x mean(1) - mean(0) -0.00897     0.0675 -0.133    0.894 0.2 -0.141  0.123\n\nColumns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high, predicted_lo, predicted_hi, predicted \nType:  response \n```\n\n\n:::\n\n```{.r .cell-code}\navg_comparisons(fit2, variables=\"x\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Term          Contrast Estimate Std. Error    z Pr(>|z|)     S 2.5 % 97.5 %\n    x mean(1) - mean(0)    0.393      0.029 13.5   <0.001 136.3 0.336   0.45\n\nColumns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high, predicted_lo, predicted_hi, predicted \nType:  response \n```\n\n\n:::\n:::\n\n\n\n:::\n\n::: {.callout-tip collapse=\"true\"}\n\n## Explain how this proves (to statistical error) that our target query was not identified\n\nanswer: there were two datasets with two different underlying models. Both yielded the same distribution in terms of observed variables $X,Y$, but when using the `unobserved` variable $U$, we could see both models had different answers to our query.\n\n:::\n\n# Counterfactual computations\n\nUse the following information on patient John:\n\n- age: 60\n- hypertension: true\n- diabetes: true\n- intervention: weight-loss program\n- survival-time: 10\n\nIn addition to the following structural equation, where u denotes an (unobserved) exogenous noise variable, such that $E[u] = 0$ (i.e. the mean is 0):\n\n$$\\text{survival-time} = 120 - \\text{age} - 10*\\text{hypertension} - 15*\\text{diabetes} + 5*\\text{weight-loss-program} + u$$\n\n::: {.callout-tip collapse=\"true\"}\n\n## calculate the expected survival time for patients like John with and without the weight-loss program\n\nanswer:\n\n\\begin{align}\n  E[\\text{survival-time}|\\text{do}(\\text{program}=0),...] &= E[120 - 60 - 10 - 15 + u] \\\\\n                                                   &= 120 - 60 - 10 - 15 + E[u] \\\\\n                                                   &= 35 + E[u] \\\\\n                                                   &= 35 + 0 \\\\\n                                                   &= 35 \\\\\n\\end{align}\n\n\\begin{align}\n  E[\\text{survival-time}|\\text{do}(\\text{program}=1),...] &= E[120 - 60 - 10 - 15 + 5 + u] \\\\\n                                                   &= 120 - 60 - 10 - 15 + 5 + E[u] \\\\\n                                                   &= 40 + E[u] \\\\\n                                                   &= 40 + 0 \\\\\n                                                   &= 40 \\\\\n\\end{align}\n\n:::\n\n::: {.callout-tip collapse=\"true\"}\n\n## Calculate the survival time for John, given that he took the weight-loss-program and survived 10 year, if he would not have taken the weigth-loss-program\n\nanswer: \n\n### step 1. abduction: infer John's u\n\nJohn's expected survival time with the program (which he had) was 35 years.\nHe lived for 10 years.\nWe can infer that his $u=-25$\n\n### step 2. action: modify the treatment\n\nWe update his treatment status to 'no weight-loss-program', the formula is now the second answer to the previous question\n\n### step 3. predict:\n\nGiven John's $u=-25$ and his other observed values, we can now calculate that his expected survival time was $5$ years if he would not have taken the weight-loss program.\n\n### \n\n:::\n\n# Meta-learners\n\n::: {.callout-note collapse=\"false\"}\n\n## Remember the definition of the conditional average treatment effect (CATE) from [lecture 4](../../lectures/day2-scms/lec4.html#sec-metalearnes)\n\n$\\text{CATE}(w) = E[y|\\text{do}(t=1),w] - E[y|\\text{do}(t=0),w]$\n\n:::\n\n::: {.callout-note collapse=\"false\"}\n\n## Rembember the definition of the T-learner and the S-learner from [lecture 4](../../lectures/day2-scms/lec4.html#sec-metalearners):\n\n- denote $\\tau(w) = E[y|\\text{do}(t=1),w] - E[y|\\text{do}(t=0),w]$\n- T-learner: model $T=0$ and $T=1$ separately (e.g. regression separetely for treated and untreated):\n  \\begin{align}\n    \\mu_0(w) &= E[Y|\\text{do}(T=0),W=w] \\\\\n    \\mu_1(w) &= E[Y|\\text{do}(T=1),W=w] \\\\\n    \\tau(w)  &= \\mu_1(w) - \\mu_0(w)\n  \\end{align}\n- S-learner: use $T$ as just another feature (assuming $W$ is a sufficient set)\n  \\begin{align}\n    \\mu(t,w) &= E[Y|T=t,W=w] \\\\\n    \\tau(w)  &= \\mu(1,w) - \\mu(0,w)\n  \\end{align}\n\n:::\n\nWith the following datasets:\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Three datasets with the same DAG](index_files/figure-html/fig-dag-nonparametric-1.png){#fig-dag-nonparametric width=672}\n:::\n:::\n\n\n\n::: {.callout-tip collapse=\"true\"}\n\n## what learning-approach would you recommend for estimating the CATE?\n\n1. S-learner with simple basemodel and no interaction (e.g. linear regression)\n2. S-learner with non-linear base model and no interaction term (e.g. splines / boosting / ...)\n3. T-learner\n\nNOTE: we typically have data with multi-dimensional features and/or confounders. Having the above plot to decide on the right meta-learning approach is almost never possible.\n\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}