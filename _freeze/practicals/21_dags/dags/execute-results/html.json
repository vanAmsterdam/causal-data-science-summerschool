{
  "hash": "c1f6d6b6ccf72a5a7492138f515c3448",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Practical on DAGs\"\nauthor: \"Wouter van Amsterdam\"\ndate: \"2024-08-06\"\neval: false\nformat: \n  html:\n    toc: true\n    code-fold: true\n    df-print: paged\n    callout-appearance: simple\n    callout-icon: false\n    number-sections: true\nexecute:\n  eval: true\n---\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Install necessary packages if not already installed\nrequired_pkgs <- c(\"dagitty\", \"ggplot2\", \"broom\", \"purrr\", \"dplyr\", \"data.table\", \"marginaleffects\")\ncran_repo <- \"https://mirror.lyrahosting.com/CRAN/\" # <- a CRAN mirror in the Netherlands, can select another one from here https://cran.r-project.org/mirrors.html\n\nfor (pkg in required_pkgs) {\n  if (!requireNamespace(pkg, quietly = TRUE)) {\n    install.packages(pkg, repos=cran_repo)\n  }\n}\n\nsuppressPackageStartupMessages({\n  # Load packages\n  library(purrr)\n  library(broom)\n  library(dagitty)\n  library(ggplot2)\n  library(dplyr)\n  library(marginaleffects)\n  library(data.table)\n})\n\nsource(here::here(\"practicals\", \"21_dags\", \"_makedatas.R\"))\ndatas <- make_datas()\nbirthw <- datas[['birthw']]\n```\n:::\n\n\n\n# Exercise: making a DAG and specifying the correct adjustment set\n\nIn this example we'll practice creating a DAG, and we'll see how using the wrong DAG leads to the wrong analysis and wrong answers.\n\nOur question is \"what is the effect of maternal smoking during pregnancy on neonatal death within 3 months\" (expressed as a difference in percentage risk for smoking / no smoking)\n\n## Birthweight data:\n\nWe'll use the (simulated) dataset `birthw` with data on birthweight and survival of babies.\n\nThe `birthw` dataset contains the following variables:\n\n- `ageover35`: Indicator mother's age over 35 years (0 = age <= 35, 1 = age >35)\n- `smoking`: Smoking status during pregnancy (0 = no, 1 = yes)\n- `lbwt`: Low birth weight (0 = >=2500grams, 1 = < 2500grams)\n- `death`: Neonatal death within 3 months (0 = no, 1 = yes)\n\nThe data can be downloaded here: [birthw.csv](datas/birthw.csv)\n\n## Create a DAG\n\n### Think of a DAG that may fit this data using the observed variables\n\nTake a few minutes to create a DAG (collaboratively) (using e.g. [dagitty.net](https://dagitty.net))\n\n### Are there variables that may be missing in the data but are relevant?\n\nIf so, add them to the DAG, and indicate that they are unobserved\n\n### With your DAG, can the causal effect be estimated?\n\nUse e.g. [dagitty.net](https://dagitty.net) to create your DAG and see if there are ways to estimate the causal effect.\n\n## Analyse the data\n\nLet's try some analyses on the data.\nWe'll fit different logistic regression models with different covariates (independent variables).\nSpecifically, fit a model with:\n\n1. all observed covariates (`fit_allobs`)\n2. only the smoking variable (`fit_marginal`)\n\nThese models give us estimates of (log) odds ratios for the independent variables.\nTo translate a logistic regression model into differences in probabilities we use the `avg_comparisons` function from the `marginaleffects` package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrequire(marginaleffects)\n\nfit_allobs <- glm(death~., data=birthw, family=\"binomial\")\nfit_marginal <- glm(death~smoking, data=birthw, family=\"binomial\")\n\navg_comparisons(fit_allobs, variables=\"smoking\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Estimate Std. Error     z Pr(>|z|)    S  2.5 %  97.5 %\n    -0.13     0.0179 -7.25   <0.001 41.1 -0.165 -0.0948\n\nTerm: smoking\nType: response\nComparison: 1 - 0\n```\n\n\n:::\n\n```{.r .cell-code}\navg_comparisons(fit_marginal, variables=\"smoking\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Estimate Std. Error    z Pr(>|z|)   S  2.5 % 97.5 %\n   0.0808     0.0288 2.81  0.00502 7.6 0.0244  0.137\n\nTerm: smoking\nType: response\nComparison: 1 - 0\n```\n\n\n:::\n:::\n\n\nThe effect estimates of `fit_allobs` and `fit_marginal` are quite different, they have different signs. How could this be explained?\nWhich effect estimate do you think is more credible?\n\n## Assume a DAG\n\n:::{.callout-tip collapse=\"true\"}\n\n## Assume the following DAG\n\n![DAG for smoking and death](_tikzs/dag-birthweight.png){#fig-dagsmoke}\n\nIn this DAG, there is another variable `gene` that influences both `lbwt` and `death`.\n\n:::\n\n:::{.callout-tip collapse=\"true\"}\n\n## How does this DAG change the analysis? (tip: enter it in dagitty.net)\n\nanswer: the `smoking`-`death` relationship has no confounders, the marginal estimate is correct.\nAdjusting for `lbwt` 'washes-out' part of `smoking`'s effect because `lbwt` is a mediator.\nAlso, `lbwt` is a collider between `gene` and `smoking`, and `gene` has a direct arrow into `death`.\nConditioning on `lbwt` opens a bidirected path between `smoking` and `gene`, creating a new backdoor path.\nSo there are two reasons not to condition on `lbwt`: it is a mediator and a collider with an unmeasured variable\n\n:::\n\n:::{.callout-tip collapse=\"true\"}\n\n## See this other DAG on the smoking question\n\n![birthweight DAG 2](_tikzs/dag-birthweight2.png){#fig-dagsmoke2}\n\n:::\n\nGiven the DAG in @fig-dagsmoke2, see the following regression model\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\nfit2 <- glm(death~smoking+ht+ageover35, data=birthw, family=binomial)\n```\n:::\n\n\n:::{.callout-note collapse=\"true\"}\n\n## Assuming no parametric form bias, will this lead to an unbiased causal effect estimate?\n\nanswer: yes this is a correct analysis. `lbwt` is still a collider, but it does not open any new back-door paths because `gene` no longer has a direct effect on `death` and all variables other than `smoking` that do have such an arrow are in the conditioning set (`ageover35`,`ht`) so these paths are blocked\n\n:::\n\n# DAG assumptions: conditional independencies and strength of assumptions\n\nDAGs imply (conditional) indepencies. These can be checked with data.\n\nSee the DAGs in @fig-dags1.\n\n::: {#fig-dags1 layout-ncol=3}\n\n![collider](../../lectures/day2-scms/_tikzs/dag-collider.png){#fig-collider}\n\n![chain](../../lectures/day2-scms/_tikzs/dag-chain.png){#fig-chain}\n\n![confounded](../../lectures/day2-scms/_tikzs/dag-dag1x.png){#fig-dag1}\n\n:::\n\n\n::: {.callout-tip collapse=\"true\"}\n## What independencies are implied by the DAGs?\n\nanswer: \n\n- @fig-collider: $X \\perp Y$\n- @fig-chain: $X \\perp Y | M$\n- @fig-dag1: none\n\n:::\n\nWe generated datasets according to each DAG named `df1`, `df2` and `df3`, but forgot what dataset corresponded to what DAG.\n\n::: {.callout-note}\n\n## Assume linear models with Gaussian error terms for all variables, how would you test the conditional independencies to figure out what DAG corresponds to what dataset?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(lm(y~x, data=df1))\nsummary(lm(y~x+z, data=df1))\n\nsummary(lm(y~x, data=df2))\nsummary(lm(y~x+z, data=df2))\n\nsummary(lm(y~x, data=df3))\nsummary(lm(y~x+z, data=df3))\n```\n:::\n\n\n:::\n\n::: {.callout-tip collapse=\"true\"}\n\n## The datasets are downloadable here:\n\n|data|link|\n|----|----|\n|`df1`|[data1.csv](datas/data1.csv)\n|`df2`|[data2.csv](datas/data2.csv)\n|`df3`|[data3.csv](datas/data3.csv)\n\n:::\n\nSee the results of the analyses summarized below in @tbl-indeptests\n\n\n::: {#tbl-indeptests .cell tbl-cap='P-values for coefficient of variable x in linear regression model'}\n\n```{.r .cell-code  code-fold=\"true\"}\ndfnames <- c(\"df1\", \"df2\", \"df3\")\nfits_marginal    <- map(dfnames, function(dfname) lm(y~x, data=datas[[dfname]]))\nfits_conditional <- map(dfnames, function(dfname) lm(y~x+z, data=datas[[dfname]]))\nnames(fits_marginal) <- dfnames\nnames(fits_conditional) <- dfnames\n\nresults_marginal <- map(fits_marginal, broom::tidy) |> rbindlist(idcol=\"dataset\")\nresults_conditional <- map(fits_conditional, broom::tidy) |> rbindlist(idcol=\"dataset\")\nresults_df <- rbindlist(list(\n  marginal = results_marginal,\n  conditional = results_conditional\n), idcol=\"analysis\")\nresults_df[, rformula:=ifelse(analysis==\"marginal\", \"lm(y~x)\", \"lm(y~x+z)\")]\n\ndcast(results_df[term%in%c(\"x\")], dataset ~ rformula, value.var=\"p.value\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"dataset\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"lm(y~x)\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"lm(y~x+z)\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"df1\",\"2\":\"6.177631e-25\",\"3\":\"7.594672e-01\"},{\"1\":\"df2\",\"2\":\"2.874718e-34\",\"3\":\"1.025833e-06\"},{\"1\":\"df3\",\"2\":\"8.210260e-01\",\"3\":\"3.478993e-02\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n::: {.callout-tip collapse=\"true\"}\n\n## What is the conclusion regarding what dataset corresponds to what DAG?\n\nanswer:\n\n- `df1`: @fig-chain\n- `df2`: @fig-dag1\n- `df3`: @fig-collider\n\n:::\n\n\n## Non-coding questions\n\n### Strength of Assumptions\n\n::: {#fig-3dags layout-ncol=3}\n\n![DAG](_tikzs/daga.png){#fig-daga}\n\n![DAG](_tikzs/dagb.png){#fig-dagb}\n\n![DAG](_tikzs/dagc.png){#fig-dagc}\n\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## What is the correct ordering of the strength of assumptions in the above DAGs, starting with the strongest assumption\n\nanswer: @fig-dagb > @fig-dagc > @fig-daga\n\n@fig-dagb is stronger than @fig-dagc as in the latter, it could be that the effects through $W$ are all absent (remember that the presence of an arrow from A to B implies a **possible** effect of A on B)\n\n@fig-dagc is stronger than @fig-daga as in the first, Z can **only** affect Y through T and W, whereas in @fig-daga Z *can* effect Y through T and *can* effect Y through other paths (e.g. W)\n\nsee also the [lecture on DAGs](../../lectures/day2-scms/lec1.qmd#sec-assumptions)\n\n:::\n\n### RCTs\n\nAccording to the DAG framework, why are RCTs especially fit for causal questions?\n\n1. they are often infeasible and unethical\n2. they sample data from the target distribution\n3. they have better external validity than observational studies\n4. randomization balances confounders\n\n::: {.callout-tip collapse=\"true\"}\n## Which answers are true?\n\nanswer: 2.\n\nSee also [the DAG lecture](../../lectures/day2-scms/lec1.qmd#sec-def-intervention)\n\nContext:\n\n1. This is often said of RCTs but has no direct bearing on why they are special for causal inference\n2. Remember that the target distribution has no arrows going in to the treatment variable, this is what we get in a RCT\n3. RCTs are often critiqued as having *poor* external validity, because they may recruit non-random subpopulations from the target population\n4. This is a subtle point, but RCTs have no confounders as there are no common causes of the treatment and the outcome. Variables that are confounders in observational studies are prognostic factors in RCTs, as they (by definition of being a confounder in an observational study) influence the outcome, but not the treatment in the RCT. Randomization balances the distribution of prognostic factors between treatment arms *in expectation*. In a particular RCT, observed (and unobserved) prognostic factors will always have some random variation between treatment arms. This does not reduce the validity of the RCT in terms of bias. This variation is reflected in the standard error of the estimate. In some cases, adjusting for known prognostic factors in RCTs may reduce the variance of the treatment estimate (i.e. narrowing the confidence interval), but this is an entire discussion on its own.\n\n:::\n\n# Confounder adjustment with Daggity\n\nIn this exercise we will use the dagitty package for creating and manipulating DAGs.\n\n## Creating and Visualizing a DAG\n\n\nLet's create a DAG for the pregnancy example:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Define the DAG\ndag <- dagitty(\"dag {\n  pregnancy_risk -> hospital_delivery\n  pregnancy_risk -> neonatal_outcome\n  hospital_delivery -> neonatal_outcome\n}\")\n\n# Plot the DAG\nplot(dag)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nPlot coordinates for graph not supplied! Generating coordinates, see ?coordinates for how to set your own.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](dags_files/figure-html/makedag-1.png){width=672}\n:::\n:::\n\n\nThis DAG assumes that pregnancy risk influences both the likelihood of hospital delivery and neonatal outcomes, and that hospital delivery affects neonatal outcomes.\n\n### Simulating Data\n\nWe will simulate data based on the DAG structure:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\n\nn <- 10000\n\n# Simulate variables\npregnancy_risk <- rbinom(n, 1, 0.3)  # 30% high risk\nhospital_delivery <- rbinom(n, 1, 0.5 + 0.3 * pregnancy_risk)  # 50% baseline + 30% if high risk\nneonatal_outcome <- rbinom(n, 1, 0.8 - 0.3 * pregnancy_risk + 0.15 * hospital_delivery)  # outcome affected by both\n\n# Create a data frame\ndf <- data.table(pregnancy_risk, hospital_delivery, neonatal_outcome)\n```\n:::\n\n\n### Analyzing the Data\n\nCheck the relationships in the data:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Summary statistics\nsummary(df)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n pregnancy_risk   hospital_delivery neonatal_outcome\n Min.   :0.0000   Min.   :0.0000    Min.   :0.0000  \n 1st Qu.:0.0000   1st Qu.:0.0000    1st Qu.:1.0000  \n Median :0.0000   Median :1.0000    Median :1.0000  \n Mean   :0.2952   Mean   :0.5859    Mean   :0.7982  \n 3rd Qu.:1.0000   3rd Qu.:1.0000    3rd Qu.:1.0000  \n Max.   :1.0000   Max.   :1.0000    Max.   :1.0000  \n```\n\n\n:::\n\n```{.r .cell-code}\n# Plot the data\nggplot(df, aes(x = factor(hospital_delivery), fill = factor(neonatal_outcome))) +\n  geom_bar(position = \"fill\") +\n  facet_grid(~ pregnancy_risk) +\n  labs(x = \"Hospital Delivery\", y = \"Proportion\", fill = \"Neonatal Outcome\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](dags_files/figure-html/checks-1.png){width=672}\n:::\n:::\n\n\n### Causal Inference Using DAGs\n\nLet's use the DAG to determine what to condition on to estimate the causal effect of hospital delivery on neonatal outcomes:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Identify adjustment set using DAGitty\nadjustmentSets(dag, exposure = \"hospital_delivery\", outcome = \"neonatal_outcome\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n{ pregnancy_risk }\n```\n\n\n:::\n:::\n\n\nThe output will suggest which variables to condition on to estimate the causal effect correctly. In this case, we need to condition on pregnancy_risk.\n\n### Estimating the Causal Effect\n\nEstimate the causal effect using a regression model:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit a regression model\nmodel <- glm(neonatal_outcome ~ hospital_delivery + pregnancy_risk, family = binomial, data = df)\n\n# Summarize the model\nsummary(model)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = neonatal_outcome ~ hospital_delivery + pregnancy_risk, \n    family = binomial, data = df)\n\nCoefficients:\n                  Estimate Std. Error z value Pr(>|z|)    \n(Intercept)        1.48278    0.04048   36.63   <2e-16 ***\nhospital_delivery  1.15677    0.06169   18.75   <2e-16 ***\npregnancy_risk    -1.91810    0.06177  -31.05   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 10057.8  on 9999  degrees of freedom\nResidual deviance:  8896.9  on 9997  degrees of freedom\nAIC: 8902.9\n\nNumber of Fisher Scoring iterations: 5\n```\n\n\n:::\n:::\n\n\n### Drawing Conclusions\n\nInterpret the model's output to understand the effect of hospital delivery on neonatal outcomes, controlling for pregnancy risk.\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_comparisons(model, variables=\"hospital_delivery\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Estimate Std. Error    z Pr(>|z|)     S 2.5 % 97.5 %\n    0.166     0.0084 19.8   <0.001 286.7  0.15  0.183\n\nTerm: hospital_delivery\nType: response\nComparison: 1 - 0\n```\n\n\n:::\n:::\n\n\n:::{.callout-note collapse=\"true\"}\n\n## Is this odds ratio a correct estimate of the causal effect?\n\nanswer: no\n\nhint: compare the structural equation used in generating the data with the statistical analysis\n\nThis linear probability structural equation is not well-approximated by a linear logistic model (i.e. without interaction terms).\nWe can model the outcome without making parametric assumptions by including an interaction term, and then extract the risk difference using `avg_comparisons` from package `marginaleffects`.\n\nThe correct estimate is given by:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfull_model <- glm(neonatal_outcome~hospital_delivery*pregnancy_risk, family=binomial, data=df)\navg_comparisons(full_model, variables=\"hospital_delivery\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Estimate Std. Error    z Pr(>|z|)     S 2.5 % 97.5 %\n    0.152    0.00869 17.5   <0.001 225.2 0.135  0.169\n\nTerm: hospital_delivery\nType: response\nComparison: 1 - 0\n```\n\n\n:::\n:::\n\n\n:::\n\n",
    "supporting": [
      "dags_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}